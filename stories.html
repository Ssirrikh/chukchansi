<!DOCTYPE html>
<html lang='en' xml:lang='en'>
<head>
	<meta charset = 'utf-8'>
	<title>Chukchansi Story Reader</title>
    <meta name='robots' content='index, follow'>
    <meta name='description' content='An interactive story reader with traditional Chukchansi stories and legends told by a native speaker in a read-along web app.'>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
		:root {
			--background-nav: #461220; /* navbar */
			/*--text-nav: #ffdab3; /* navbar */
            --text-nav: #ffd994;

            --background-selected: #6b4226;
            --background-unselected: #eac8a2;
			
			--background-search: #ffffff; /* searchbar */
			--icon-search: #826545; /* searchbar inset icons */

			--background-light: #f2e3d3; /* main content bg */
			--background-inset: #dbb78f; /* inset panels; vibrant bg */
			--background-medium: #bfa07e; /* side panels; muted bg */
			--background-dark: #ad8e6c; /* fractionally darker interactibles bg */
			--text-dark: #4f3a09; /* main content text */
			--text-medium: #75544b; /* interactible text */
			--text-light: #fdf7ea;

			--border-dark: #4f3a09; /* content separation */
			--border-medium: #75544b; /* inset panel border */
			--border-light: #bfa07e; /* interactible textbox border */

			--layer-front: 2; /* elems that hover over content (hanging tabs, search history) */
			--layer-nav: 3; /* nav elements are always topmost */
			--layer-overlay: 5; /* modal overlays */

            --fluid-font-size: max(3vh, calc(1rem + 1.0vw));
            --content-pad: 1rem;
            /* --title-font-size: 1.25em; */
            /*--nav-height: calc(2.25 * var(--fluid-font-size)); /* ref height for content anchors */

			--thumbnail-position: center center / cover no-repeat;
		}

		* {
			margin: 0px;
			padding: 0px;
			box-sizing: border-box;
			font-family: 'Times New Roman';
		}
		body {
			background-color: var(--background-nav);
            font-size: var(--fluid-font-size);
		}

        /* unstyle elements */
        button {
            color: var(--text-dark);
            background-color: transparent;
            border: none;
            outline: none;
        }
        h1 {
            font-size: 1.0em;
            font-weight: normal;
        }

		.flex-sep {
			width: 0;
			flex-grow: 1;
		}
		.flex-row {
			display: flex;
			flex-direction: row;
			align-items: start;
		}
		.flex-col {
			display: flex;
			flex-direction: column;
		}

        /* mobile-first for better load times on less-powerful devices */
        @media (max-aspect-ratio: 5/4) { /* mobile mode */
            :root {
                --title-font-size: calc(1.17 * var(--fluid-font-size));
                --nav-height: calc(1.75 * var(--fluid-font-size)); /* ref height for content anchors */
            }
            .flex-adapt {
                display: flex;
                flex-direction: column;
                /* justify-content: center; */
                align-items: center;
            }
            #selection-panel {
                border-bottom: 0.1em solid var(--border-light);
                width: 100vw;
            }
            .player-panel {
                width: calc(100vw - 0.5em - 0.5em); /* prevent panel from shrinking horizontally on mobile if content is skinny */
            }
        }
		@media (min-aspect-ratio: 5/4) { /* desktop mode */
            :root {
                --title-font-size: 1.0em;
                --nav-height: calc(1.5 * var(--fluid-font-size)); /* ref height for content anchors */
            }
			.flex-adapt {
				display: flex;
				flex-direction: row;
				justify-content: center;
				/* align-items: center; */
			}
            #selection-panel {
                border-right: 0.1em solid var(--border-light);
                position: sticky;
                top: var(--nav-height);
                width: 33vw;
                height: calc(100vh - var(--nav-height));
            }
		}

		/* nav bar */
		#nav-bar {
			color: var(--text-nav);
			background-color: var(--background-nav);

			position: sticky;
			padding: 0.25em;
			top: 0px;
			width: 100%;
            font-size: var(--title-font-size);
            text-align: center;

			z-index: var(--layer-front); /* make sure nav elems and hanging tabs are on top of other content */
		}
        #nav-title {
            line-height: var(--title-font-size);
        }
        #nav-menu {
            /* https://www.sliderrevolution.com/resources/css-dropdown-menu/ */
            cursor: pointer;
            /* background-color: var(--text-nav); */
            /* border: 1px solid red; */

            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
            width: var(--nav-height);
            height: var(--nav-height);
        }
        /* #nav-menu span {
            background-color: #00f;
            border-radius: 0.1em;
            
            display: inline-block;
            width: 100%;
            height: 0.1em;
        } */
        /* #nav-menu ul {
            color: var(--text-dark);
            background-color: var(--background-medium);
            border: 1px solid var(--border-light);
            border-top: 1px solid var(--text-light);

            visibility: hidden;
            position: absolute;
            top: var(--nav-height);
            left: 0px;

            text-align: left;
            list-style: none;
            gap: 1px;
        } */
        #nav-menu ul {
            cursor: default;
            color: var(--text-dark);
            background-color: var(--background-unselected);
            border-top: 1px solid var(--text-light);
            border-bottom: 1px solid var(--border-light);

            visibility: hidden;
            position: absolute;
            top: var(--nav-height);
            left: 0px;
            width: 100vw;
            /* padding: 0.25em 0; */
            padding: 0.25em;

            text-align: left;
            list-style: none;
            flex-wrap: wrap;
        }
        #nav-menu div + div {
            border-left: 1px solid var(--text-dark);
        }
        #nav-menu ul li {
            cursor: pointer;
            color: var(--text-dark);
            padding: 0.15em 0.75em;
            font-size: 0.8em;
        }
        #nav-menu ul li:hover {
            /* color: var(--background-light); */
            color: var(--text-nav);
            background-color: var(--background-selected);
        }
        #nav-menu:focus-within > ul, #nav-menu:hover ul {
            visibility: visible;
        }
        #nav-menu ul li a {
            color: inherit;
            text-decoration: inherit;
        }
        .nav-greyed-out {
            cursor: default;
            color: var(--text-dark);
            padding: 0.15em 0.75em;
            font-size: 0.8em;
            opacity: 50%;
        }

        /* layout */
        #content {
            background-color: var(--background-light);
            min-height: calc(100vh - var(--nav-height));
        }
		#selection-panel {
            color: var(--text-dark);
/*            background-color: transparent;*/
/*            background-color: var(--background-medium);*/
            /* border: 0.2em solid var(--border-dark); */
/*            border-radius: 1em;*/

            display: block;
            padding: 1em;
            overflow-x: hidden;
            overflow-y: scroll;
        }
        #reader-panel {
            color: var(--text-dark);
            background-color: transparent;

            scroll-margin-top: var(--nav-height);
            flex-grow: 1;
        }

        /* selection panel */
        .selection-panel-title {
            margin-bottom: 0.5em;
            font-size: 1.2em;
            /* text-align: center; */
            /* font-weight: bold; */
            text-decoration: underline;
        }
        .selection-panel-row {
            cursor: pointer;
            gap: 0.5em;
            align-items: center;
        }
        .selection-panel-row + .selection-panel-row {
            margin-top: 2px;
        }
        .selection-greyed-out {
            cursor: default;
            opacity: 0.5;
        }
        .selection-panel-story-thumbnail {
            --w: 2.0em;
            background-color: var(--background-nav);
            border: 1px solid transparent;

            width: var(--w);
            height: var(--w);
            flex-shrink: 0;
        }
        .selection-panel-story-title {
            font-size: 1.0em;
        }
        .selection-panel-story-subtitle {
            font-size: 0.5em;
        }

        /* story reader */
        #reader-title, #player-loading-text {
            font-size: 1.2em;
            text-decoration: underline;
            text-align: center;
        }
        #reader-subtitle {
            /*margin-top: -0.5em; /* negate flexbox gap between title/subtitle */
            font-size: 0.8em;
            text-align: center;
        }
        #reader-content {
            margin-top: 1.0em;
            font-size: 1.0em;
            text-wrap: wrap;
            text-align: center;

            gap: 0.75em;
        }
        .reader-section + .reader-section {
            margin-top: 0.5em;
        }
        .reader-section {
            display: inline;
        }
        .reader-section-translation {
            display: inline;
            font-size: 0.8em;
            font-style: italic;
        }
        .reader-highlight {
            background-color: var(--background-inset);
        }
        #scroll-to-top {
            cursor: pointer;
            border-top: 0.1em solid var(--border-light);
            border-bottom: 0.1em solid var(--border-light);
            background-color: var(--background-inset);
            /* filter: drop-shadow(0 0 4px #0008); */

            margin-bottom: 1.0em;
            padding: 0.25em 0px;
        }

        /* audio player controls */
        .player-panel {
            color: var(--text-dark);
            background-color: var(--background-inset);
            border: 0.2em solid var(--border-dark);
            border-radius: 1em;
            filter: drop-shadow(0 0 4px #0006);

            position: sticky;
            margin: 0.5em;
            padding: 0.5em;
            top: calc(0.5em + var(--nav-height));

            justify-content: center;
            align-items: center;
        }
        .player-controls {
            margin-top: 0.5em;
            gap: 1.5em;
            justify-content: center;
            align-items: center;
        }
        .player-button-small {
            /* mobile browsers mess w/ buttons to "make them big enought to click" but fail epically; need to set both height and font-size to override */
            --button-size-small: 1.1em;
            cursor: pointer;
            width: var(--button-size-small);
            height: var(--button-size-small);
            font-size: var(--button-size-small);
        }
        .player-button-large {
            /* mobile browsers mess w/ buttons to "make them big enought to click" but fail epically; need to set both height and font-size to override */
            --button-size-large: 1.2em;
            cursor: pointer;
            width: var(--button-size-large);
            height: var(--button-size-large);
            font-size: var(--button-size-large);
        }
        .player-progress-text {
            width: 12em;
            font-size: 0.8em;
        }
        #player-progress {
            cursor: pointer;
            background-color: transparent;

            display: inline-block;
            position: relative;
            width: 12em;
            height: 0.4em;
            font-size: 0.8em;
        }
        #player-progress-background {
            background-color: var(--background-medium);

            display: block;
            position: absolute;
            width: 100%;
            height: 0.2em;
            top: 50%;
            transform: translate(0,-50%);
        }
        #player-progress-bar {
            background-color: var(--text-dark);

            display: block; /* if not set to display:block, element will appear outside of parent, offset down by 3x its height; no clue why; google/gpt says flexbox doesn't play nice with display:inline-block and I should just avoid using them together */
            position: relative;
            width: 50%;
            height: 100%;
            top: 0;
            left: 0;
        }
        #player-progress-slider {
            cursor: pointer;
            background-color: var(--background-nav);

            display: inline-block;
            position: absolute;
            width: 0.5em;
            height: 0.5em;
            top: 50%;
            right: 0;
            transform: translate(50%,-50%) rotate(45deg);
        }

        /* loading screen */
        #player-loading-screen {
            background-color: var(--background-inset);

            position: absolute;
            padding: 0.25em;
            width: calc(100% - 0.25em - 0.25em);
            height: calc(100% - 0.25em - 0.25em);
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);

            gap: 2.0em;
            align-items: center;
        }
        .loading-animation-track {
            display: inline-block;
            position: relative;
            width: 2em;
        }
        .loading-icon-full, .loading-icon-empty {
            display: inline-block;
            position: absolute;
            width: 1.0em;
            height: 1.0em;
            transform: translate(-50%,-50%) rotate(45deg);
        }
        .loading-icon-full {
            background-color: var(--background-nav);
            left: 0%;

            animation: loading-left 1.5s ease infinite;
        }
        .loading-icon-empty {
            background-color: var(--background-inset);
            border: 0.1em solid var(--background-nav);
            left: 100%;

            animation: loading-right 1.5s ease infinite;
        }
        /* loading animation: 2 diamonds slide past each other, changing which one is on top */
        @keyframes loading-left {
            /* z-index changes at midpoint between keyframes, use fractional keyframes to set midpoint where diamonds don't overlap */
            0%   { left:0%;   z-index:1; }
            49%  { left:100%; z-index:1; }
            50%  { left:100%; z-index:2; }
            99%  { left:0%;   z-index:2; }
            100% { left:0%;   z-index:1; }
        }
        @keyframes loading-right {
            /* z-index changes at midpoint between keyframes, use fractional keyframes to set midpoint where diamonds don't overlap */
            0%   { left:100%; z-index:2; }
            49%  { left:0%;   z-index:2; }
            50%  { left:0%;   z-index:1; }
            99%  { left:100%; z-index:1; }
            100% { left:100%; z-index:2; }
        }

        /* /////////////////////////////// */
        
        /* thumbnail assets; hardcoded into html/css since there's a finite/limited number of stories */
        #thumbnail-0 {
            background: url('source/story-0/sox-siksikaʔ-thumbnail-small.jpg') var(--thumbnail-position);
        }
        #thumbnail-1 {
            background: url('source/story-1/kaʔyuʔun-shashaʔ-thumbnail-small.jpg') var(--thumbnail-position);
        }
        #thumbnail-2 {
            background: url('source/story-2/ʔuplalliʔ-deemaysuʔ-thumbnail-small.jpg') var(--thumbnail-position);
        }
        #thumbnail-3 {
            background: url('source/story-3/shelel\'-shilithanaʔ-thumbnail-small.jpg') var(--thumbnail-position);
        }

        #palette {
            position: absolute;
            top: 100px;
            left: 100px;
        }
        #palette-test {
            position: absolute;
            top: 150px;
            left: 100px;
        }
        #palette-test-2 {
            position: absolute;
            top: 200px;
            left: 100px;
        }
        .palette-strip {
            display: inline-block;
            width: 50px;
            height: 50px;
        }
		
	</style>
</head>
<body>

<div id='nav-bar'>
    <h1 id='nav-title'>English-Chukchansi Story Reader</h1>
    <nav id='nav-menu' role='navigation'>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="1.25" style='width:100%;height:100%;pointer-events:none;'>
            <path d="M5 8l14 0"></path>
            <path d="M5 12l14 0"></path>
            <path d="M5 16l14 0"></path>
        </svg>
        <ul id='nav-dropdown' class='flex-row'>
            <div class='flex-col'>
                <!-- <li><a>Home</a></li> -->
                <p class='nav-greyed-out'>Home</p>
            </div>
            <div class='flex-col'>
                <li><a href='/speaking-dictionary.html'>Speaking Dictionary</a></li>
                <li><a href='/pdf-dictionary.html'>PDF Dictionary</a></li>
                <li><a href='/stories.html'>Story Reader</a></li>
                <li><a href='/wordsearch.html'>Wordsearch</a></li>
                <!-- <li><a>Speaking Dictionary</a></li>
                <li><a>PDF Dictionary</a></li>
                <li><a>Story Reader</a></li>
                <li><a>Wordsearch</a></li> -->
            </div>
        </ul>
    </nav>
    <!-- <div id='palette'>
        <div class='palette-strip' style='background-color:var(--background-nav)'></div>
        <div class='palette-strip' style='background-color:var(--text-nav)'></div>
        <div class='palette-strip' style='background-color:var(--background-light)'></div>
        <div class='palette-strip' style='background-color:var(--background-inset)'></div>
        <div class='palette-strip' style='background-color:var(--text-dark)'></div>
    </div>
    <div id='palette-test'>
        <div class='palette-strip' style='background-color:#755c48'></div>
        <div class='palette-strip' style='background-color:#a67a5b'></div>
        <div class='palette-strip' style='background-color:#ccad99'></div>
        <div class='palette-strip' style='background-color:#335c67'></div>
        <div class='palette-strip' style='background-color:#2c5f2d'></div>
        <div class='palette-strip' style='background-color:#5687c7'></div>
        <div class='palette-strip' style='background-color:#ff6700'></div>
        <div class='palette-strip' style='background-color:#ffd700'></div>
    </div>
    <div id='palette-test-2'>
        <div class='palette-strip' style='background-color:#FF4500'></div>
        <div class='palette-strip' style='background-color:#FF8C42'></div>
        <div class='palette-strip' style='background-color:#FFD27F'></div>
        <div class='palette-strip' style='background-color:#C2B280'></div>
        <div class='palette-strip' style='background-color:#6B4226'></div>
    </div> -->
</div>
<div id='content' class='flex-adapt'>
    <div> <!-- need wrapper div so position:sticky plays nice with flexbox -->
        <div id='selection-panel' class='flex-col'>
            <p class='selection-panel-title'>Story Catalogue</p>

            <div class='flex-row selection-panel-row' onclick='loadStory(0)'>
                <div id='thumbnail-0' class='selection-panel-story-thumbnail'></div>
                <div class='flex-col'>
                    <p class='selection-panel-story-title'>Siksikaʔ Limeek’ataʔ</p>
                    <p class='selection-panel-story-subtitle'>How Stinkbug Became Black</p>
                </div>
            </div>
            <div class='flex-row selection-panel-row' onclick='loadStory(1)'>
                <div id='thumbnail-1' class='selection-panel-story-thumbnail'></div>
                <div class='flex-col'>
                    <p class='selection-panel-story-title'>Kaʔyuʔun Shashaʔ</p>
                    <p class='selection-panel-story-subtitle'>Why Coyote's Eyes are the Best</p>
                </div>
            </div>
            <div class='flex-row selection-panel-row' onclick='loadStory(2)'>
                <div id='thumbnail-2' class='selection-panel-story-thumbnail'></div>
                <div class='flex-col'>
                    <p class='selection-panel-story-title'>ʔuplalliʔ Deemay’suʔ</p>
                    <p class='selection-panel-story-subtitle'>Dove and Hummingbird Race Each Other</p>
                </div>
            </div>
            <div class='flex-row selection-panel-row' onclick='loadStory(3)'>
                <div id='thumbnail-3' class='selection-panel-story-thumbnail'></div>
                <div class='flex-col'>
                    <p class='selection-panel-story-title'>Shelel’ Shilithanaʔ</p>
                    <p class='selection-panel-story-subtitle'>A Rock to be Jumped</p>
                </div>
            </div>

            <br>
            <p style='margin-left:1.0em;font-style:italic;'>More coming soon!</p>
        </div>
    </div>
        
    <div id='reader-panel'>
        <div class='flex-col player-panel'>
            <div id='reader-title'>Chukchansi Title</div>
            <div id='reader-subtitle'>English Subtitle</div>
            <div class='flex-row player-controls'>
                <!-- SVG icons from Tabler: https://tablericons.com/ -->
                <button class='player-button-small' role='button' onclick='storyReader.prevClause()' aria-keyshortcuts="j" title="Jump to previous section (j)" aria-label="Jump to previous section keyboard shortcut j">
                    <svg id='prev-section' xmlns="http://www.w3.org/2000/svg" x-bind:width="size" x-bind:height="size" viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%">
                        <path d="M20.341 4.247l-8 7a1 1 0 0 0 0 1.506l8 7c.647 .565 1.659 .106 1.659 -.753v-14c0 -.86 -1.012 -1.318 -1.659 -.753z"></path>
                        <path d="M9.341 4.247l-8 7a1 1 0 0 0 0 1.506l8 7c.647 .565 1.659 .106 1.659 -.753v-14c0 -.86 -1.012 -1.318 -1.659 -.753z"></path>
                    </svg>
                </button>
                <button class='player-button-large' role='button' onclick='storyReader.togglePlayPause()' aria-keyshortcuts="k" title="Play/Pause (k)" aria-label="Play or pause story keyboard shortcut k">
                    <svg id='play-pause' xmlns="http://www.w3.org/2000/svg" x-bind:width="size" x-bind:height="size" viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%">
                        <path d="M6 4v16a1 1 0 0 0 1.524 .852l13 -8a1 1 0 0 0 0 -1.704l-13 -8a1 1 0 0 0 -1.524 .852z"></path>
                    </svg>
                </button>
                <button class='player-button-small' role='button' onclick='storyReader.nextSection()' aria-keyshortcuts="l" title="Jump to next section (l)" aria-label="Jump to next section keyboard shortcut l">
                    <svg id='next-section' xmlns="http://www.w3.org/2000/svg" x-bind:width="size" x-bind:height="size" viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%">
                        <path d="M2 5v14c0 .86 1.012 1.318 1.659 .753l8 -7a1 1 0 0 0 0 -1.506l-8 -7c-.647 -.565 -1.659 -.106 -1.659 .753z"></path>
                        <path d="M13 5v14c0 .86 1.012 1.318 1.659 .753l8 -7a1 1 0 0 0 0 -1.506l-8 -7c-.647 -.565 -1.659 -.106 -1.659 .753z"></path>
                    </svg>
                </button>
            </div>
            <div class='flex-row player-progress-text' aria-hidden='true'>
                <div id='player-time'>0:00</div>
                <div class='flex-sep'></div>
                <div id='player-duration'>0:00</div>
            </div>
            <div id='player-progress'>
                <div id='player-progress-background'>
                    <div id='player-progress-bar'>
                        <div id='player-progress-slider'></div>
                    </div>
                </div>
            </div>

            <div id='player-loading-screen' class='flex-col'>
                <p id='player-loading-text'>Loading Story...</p>
                <div class='loading-animation-track'>
                    <div class='loading-icon-full'></div>
                    <div class='loading-icon-empty'></div>
                </div>
            </div>
        </div>
        <div id='reader-content' class='flex-col' aria-hidden='true'></div>
    </div>
</div>

<!-- load story data -->
<script type='text/javascript' src="source/story-0/sox-siksikaʔ-data-annotated.js"></script>
<script type='text/javascript' src="source/story-1/kaʔyuʔun-shashaʔ-data-annotated.js"></script>
<script type='text/javascript' src="source/story-2/ʔuplalliʔ-deemaysuʔ-data-annotated.js"></script>
<script type='text/javascript' src="source/story-3/shelel'-shilithanaʔ-data-annotated.js"></script>







<script type='text/javascript'>

    //// REFS ////

    // https://open.spotify.com/playlist/37i9dQZF1DX9tPFwDMOaN1
    // https://github.com/enterprise/startups
    // https://www.w3schools.com/



    //// WAVE 3 ////

    // 1.5 hrs: set up basic page layout, audio player, and story reader
    // 2.0 hrs: annotate sox-siksika' story by sentence and integrate into story reader
    // 1.0 hrs: add story reader controls w/ partial ARIA-integration
    // 2.0 hrs: annotate sox-siksika' story by clause and add full media player functionality
    // 1.0 hrs: finish ARIA-integration for accessibility access
    // 1.5 hrs: add touch contols to media player UI, re-annotate sox-siksika' to new data format
    // 1.0 hrs: refactor dynamic page builder for new data format
    // 1.5 hrs: refactor media player for new data format, partially bugfix broken section transitions
    // 1.0 hrs: finish UI and bugfix bad scrolling behavior
    // 0.5 hrs: slap bandaid on broken things to fake correct behavior for the demo
    // 0.5 hrs: fix underlying issues that broke player.ontimeupdate() and media player seeking
    // 0.5 hrs: correct loading bug on slow devices and add minor graphical fixes
    // 4.0 hrs: research fluid typography and apply to site
    // 2.5 hrs: reconstruct fluid typography after data loss
    // 0.5 hrs: fix visual bug where position:sticky didn't stick at correct height
    // 1.5 hrs: create loading anim and partially integrate loading screen
    // 1.0 hrs: SEO research
    // 2.0 hrs: finalize loading sequence, fix inconsistent load order and seekability on some devices
    // 1.0 hrs: visual fixes and code cleanup
    // 3.5 hrs: research git repo migration, migrate demo, migrate chukchansi project
    // 1.0 hrs: research publically available chukchansi resources, create initial site readme
    // 2.0 hrs: annotate kaʔyuʔun-shashaʔ story by clause
    // 1.0 hrs: reconfigure reader for dynamic loading
    // 1.0 hrs: minor graphical fixes; ARIA research
    // 1.5 hrs: clean up kaʔyuʔun-shashaʔ images, annotate transitions, gen thumbnails
    // 1.5 hrs: improve page navigation and story selection UI
    // 2.0 hrs: data corrections, partial ʔuplalliʔ-deemay'suʔ story annotation
    // 2.0 hrs: finish annotating ʔuplalliʔ-deemaysuʔ story, begin adding shelel'-shilithanna story
    // 1.0 hrs: cleanup, push release live
    // 0.5 hrs: spelling corrections in story data
    // 1.5 hrs: annotate shelel'-shilithanaʔ story
    // 1.0 hrs: web optimization research
    // 6.0 hrs: add nav menu


    
    // DOM anchors
    const navTitle = document.getElementById('nav-title');
    const navButton = document.getElementById('nav-menu');
    const navDropdown = document.getElementById('nav-dropdown');
    const storySelectionPanel = document.getElementById('selection-panel');
    const storyReaderPanel = document.getElementById('reader-panel');
    const playPauseButton = document.getElementById('play-pause');
    const readerTitle = document.getElementById('reader-title');
    const readerSubtitle = document.getElementById('reader-subtitle');
    const readerContent = document.getElementById('reader-content');
    const playerTime = document.getElementById('player-time');
    const playerDuration = document.getElementById('player-duration');
    const playerProgressContiner = document.getElementById('player-progress');
    const playerProgressBar = document.getElementById('player-progress-bar');
    const playerLoadingScreen = document.getElementById('player-loading-screen');

    // SVG icons from Tabler: https://tablericons.com/
    const SVG_PLAY = `<path d="M6 4v16a1 1 0 0 0 1.524 .852l13 -8a1 1 0 0 0 0 -1.704l-13 -8a1 1 0 0 0 -1.524 .852z"></path>`;
    const SVG_PAUSE = `<path d="M9 4h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h2a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2z"></path><path d="M17 4h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h2a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2z"></path>`;
    // const SVG_REPEAT = `<path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747"></path><path d="M20 4v5h-5"></path>`;
    const SVG_REPEAT = `<g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="calc(0.1vh + 0.1vw)"><path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747"></path><path d="M20 4v5h-5"></path></g>`;

    const READ_BY_SENTENCE = 'timestampsBySentence';
    const READ_BY_CLAUSE = 'timestampsByClause';

    let storyReader = {
        currentStoryId   : -1,
        currentStoryData : undefined,
        currentSectionId : 0,
        player : document.createElement('audio'),
        readMode : READ_BY_CLAUSE,
        id2lineSection : [],
        lineSection2id : [],

        loadingComplete : false,
        loadStart : performance.now(),

        getCurrentTime : () => {
            const time =  storyReader.player.currentTime - storyReader.currentStoryData[storyReader.readMode][0][0];
            const m = Math.floor(time / 60);
            const ss = Math.floor(time % 60).toString().padStart(2,'0');
            return `${m}:${ss}`;
        },
        getDuration : () => {
            const time = storyReader.player.duration - storyReader.currentStoryData[storyReader.readMode][0][0];
            const m = Math.floor(time / 60);
            const ss = Math.floor(time % 60).toString().padStart(2,'0');
            return `${m}:${ss}`;
        },
        setSrc : (src) => {
            storyReader.player.pause();
            storyReader.player.src = src;
            storyReader.player.currentTime = 0;
            storyReader.currentSectionId = 0;
        },
        togglePlayPause : () => {
            if (storyReader.player.paused && storyReader.player.currentTime >= storyReader.player.duration-0.5) {
                // if finished playing, reset to earliest timestamp
                storyReader.setSectionId(0,0);
                scrollToTop();
                
            }
            (storyReader.player.paused) ? storyReader.player.play() : storyReader.player.pause();
            playPauseButton.innerHTML = (storyReader.player.paused) ? SVG_PLAY : SVG_PAUSE;
        },
        playFrom : (t) => {
            if (storyReader.player.readyState < 2) {
                console.warn('Cannot play audio, file still loading.');
                return false;
            } else {
                storyReader.player.pause();
                storyReader.player.currentTime = t;
                storyReader.player.play();
                return true;
            }
            console.log(`Playing audio from ${storyReader.currentStoryData[storyReader.readMode][3*i]}`);
        },

        highlightSection : (id) => {
            if (!storyReader.currentStoryData || id < 0 || id >= storyReader.id2lineSection.length) {
                console.error(`Section ${id} does not exist in current story, which has ${storyReader.id2lineSection.length} sections (zero-indexed).`);
                return false;
            }
            document.getElementById(`reader-section-${storyReader.currentSectionId}`).classList.remove('reader-highlight');
            document.getElementById(`reader-section-${id}`).classList.add('reader-highlight');
            return true;
        },
        setSectionId : (id) => {
            // console.log(`>> setting section from ${storyReader.currentSectionId} to ${id}`);
            if (!storyReader.highlightSection(id)) return false; // performs input validation
            storyReader.currentSectionId = id;
            const start = storyReader.currentStoryData[storyReader.readMode][0][0];
            const [line,section] = storyReader.id2lineSection[id];
            storyReader.player.currentTime = storyReader.currentStoryData[storyReader.readMode][line][section*3];
            // console.log(`Jumping to section ${id}: apparent time ${storyReader.player.currentTime-start}, actual time ${storyReader.player.currentTime}`);
            playPauseButton.innerHTML = (storyReader.player.paused) ? SVG_PLAY : SVG_PAUSE; // reset media player icon when user changes sections, to clear replay icon if previously ended
            return true;
        },
        nextSection : () => {
            // storyReader.setSectionId((storyReader.currentSectionId + 1) % (storyReader.currentStoryData[storyReader.readMode].length/3));
            if (storyReader.currentSectionId < storyReader.id2lineSection.length - 1) {
                storyReader.setSectionId(storyReader.currentSectionId + 1);
            } else if (storyReader.currentSectionId == storyReader.id2lineSection.length - 1) {
                storyReader.player.currentTime = storyReader.player.duration; // triggers player.onended()
                console.log('last section');
            }
        },
        prevClause : () => {
            // storyReader.setSectionId((storyReader.currentSectionId == 0) ? (storyReader.id2lineSection.length - 1) : (storyReader.currentSectionId-1));
            if (storyReader.currentSectionId > 0) {
                storyReader.setSectionId(storyReader.currentSectionId - 1);
            } else {
                console.log('first section');
            }
        }
    };
    storyReader.player.ontimeupdate = () => {
        // update highlighting if we started a new clause
        const nextSectionId = storyReader.currentSectionId + 1;
        if (nextSectionId < storyReader.id2lineSection.length) {
            const [nextLine,nextSection] = storyReader.id2lineSection[nextSectionId];
            if (storyReader.player.currentTime > storyReader.currentStoryData[storyReader.readMode][nextLine][3*nextSection]) {
                storyReader.highlightSection(nextSectionId);
                storyReader.currentSectionId = nextSectionId;
            }
        } else if (nextSectionId == storyReader.id2lineSection.length) {
            console.log(`in last section, don't scan for later sections`);
        } else {
            storyReader.player.currentTime = storyReader.player.duration; // triggers player.onended()
        }

        // adjust player display
        playerTime.innerHTML = storyReader.getCurrentTime();
        playerDuration.innerHTML = storyReader.getDuration();
        const time = storyReader.player.currentTime - storyReader.currentStoryData[storyReader.readMode][0][0];
        const duration = storyReader.player.duration - storyReader.currentStoryData[storyReader.readMode][0][0];
        playerProgressBar.style.width = `${100 * Math.min(Math.max(0, time/duration), 1)}%`;
    };
    storyReader.player.onended = () => {
        playPauseButton.innerHTML = SVG_REPEAT;
    };

    function loadStory (storyId) {
        if (storyId < 0 || storyId >= stories.length) {
            console.error(`ERR Story id ${storyId} not found in catalogue.`);
            return false;
        } else if (storyId == storyReader.currentStoryId) {
            console.warn(`Story id ${storyId} is already loaded.`);
            return false;
        }
        const storyData = stories[storyId];

        // reset loading cycle
        storyReader.loadStart = performance.now();
        storyReader.loadingComplete = false;
        readerContent.innerHTML = '';
        playerLoadingScreen.style.visibility = 'visible';

        // begin fetching audio
        storyReader.setSrc(storyData.audio);
        storyReader.currentStoryId = storyId;
        storyReader.currentStoryData = storyData;
        
        // index reader sections
        let id = 0;
        storyReader.id2lineSection = [];
        storyReader.lineSection2id = [];
        for (let line = 0; line < storyData[storyReader.readMode].length; line++) {
            storyReader.lineSection2id[line] = [];
            for (let i = 0; i < storyData[storyReader.readMode][line].length; i+=3) {
                const section = i / 3;
                storyReader.id2lineSection.push([line,section]);
                storyReader.lineSection2id[line].push(id);
                id++;
            }
        }
        console.log(`LOAD Story data indexed after ${(performance.now()-storyReader.loadStart).toFixed(0)} ms.`);

        // construct dynamic content (is independent of audio, but don't render until audio playable)
        let contentStr = '';
        for (let line = 0; line < storyData[storyReader.readMode].length; line++) {
            contentStr += `<div>`;
            for (let i = 0; i < storyData[storyReader.readMode][line].length; i+=3) {
                const section = i / 3;
                const id = storyReader.lineSection2id[line][section];
                const timestamp = storyData[storyReader.readMode][line][i];
                const textCHK = storyData[storyReader.readMode][line][i+1];
                const textENG = storyData[storyReader.readMode][line][i+2];
                contentStr += `<p><span id='reader-section-${id}' class='reader-section' onClick='storyReader.setSectionId(${id})'>${textCHK}</span></p>`;
                contentStr += '\n';
                contentStr += `<p><span id='reader-section-translation-${id}' class='reader-section-translation' onClick='storyReader.setSectionId(${id})'>${textENG}</span></p>`;
            }
            contentStr += `</div>`;
        }
        contentStr += `<p id='scroll-to-top' onclick='scrollToTop()'>Scroll to Top</p>`;
        console.log(`LOAD Dynamic content generated after ${(performance.now()-storyReader.loadStart).toFixed(0)} ms.`);

        // render content to screen only after audio is playable
        function trySetInitialTime (t0) {
            if (storyReader.player.currentTime == t0) {
                console.log(`LOAD First section seekable after ${(performance.now()-storyReader.loadStart).toFixed(0)} ms.`);
                readerContent.innerHTML = contentStr;
                storyReader.setSectionId(0);
                playerLoadingScreen.style.visibility = 'hidden';
                console.log(`LOAD Dynamic content rendered after ${(performance.now()-storyReader.loadStart).toFixed(0)} ms.`);
            } else if (storyReader.player.readyState >= 2) {
                storyReader.player.currentTime = t0;
                // console.log(`LOAD Set audio currentTime to ${storyReader.player.currentTime}`);
                setTimeout(()=>trySetInitialTime(t0), 50);
            } else {
                setTimeout(()=>trySetInitialTime(t0), 50);
            }
        }
        storyReader.player.onloadedmetadata = () => {
            console.log(`LOAD Audio metadata available after ${(performance.now()-storyReader.loadStart).toFixed(0)} ms.`);
        };
        storyReader.player.oncanplay = () => {
            if (!storyReader.loadingComplete) {
                storyReader.loadingComplete = true;
                readerTitle.innerHTML = storyData.titleCHK;
                readerSubtitle.innerHTML = storyData.titleENG;
                console.log(`LOAD Audio first frame playable after ${(performance.now()-storyReader.loadStart).toFixed(0)} ms.`);
                trySetInitialTime(storyReader.currentStoryData[storyReader.readMode][0][0]);
            }
        };

        return true;
    }

    /////////////////////

    function scrollToTop () {
        storyReaderPanel.scrollIntoView({ block: 'start', behavior: 'smooth' }); // has scroll-margin-top to account for navbar
    }

    function seekTo (p = 0.0) {
        p = Math.min(Math.max(0,p),1);
        
        const start = storyReader.currentStoryData[storyReader.readMode][0][0];
        const duration = storyReader.player.duration;
        const t = start + p*(duration-start);
        for (let sectionId = 0; sectionId < storyReader.id2lineSection.length; sectionId++) {
            const [line,section] = storyReader.id2lineSection[sectionId];
            const [nextLine,nextSection] = storyReader.id2lineSection[sectionId+1] ?? [];
            const t0 = storyReader.currentStoryData[storyReader.readMode][line][3*section];
            const t1 = (nextLine!=undefined) ? storyReader.currentStoryData[storyReader.readMode][nextLine][3*nextSection] : duration;
            // console.log(`checking t=${t} against (t0,t1)=(${t0},${t1})`);
            if (t > t0 && t < t1) {
                storyReader.highlightSection(sectionId);
                storyReader.currentSectionId = sectionId;
                storyReader.player.currentTime = t;
                console.log(`${(100*p).toFixed(2)}% - section ${sectionId} at time ${t}`);
                return;
            }
        }
        console.log(`ERR Unable to seek to ${(100*p).toFixed(2)}% (time ${t})`);
    }

    let dragPlayer = false;
    playerProgressContiner.addEventListener('mousedown', e => {
        dragPlayer = true;
        const b = playerProgressContiner.getBoundingClientRect();
        seekTo( (e.clientX - b.left) / b.width );
    });
    playerProgressContiner.addEventListener('mousemove', e => {
        if (dragPlayer) {
            const b = playerProgressContiner.getBoundingClientRect();
            seekTo( (e.clientX - b.left) / b.width );
        }
    });
    playerProgressContiner.addEventListener('mouseup', e => {
        dragPlayer = false;
    });

    window.addEventListener('keydown', e => {
        // console.log(e.key);
        // e.preventDefault();
        switch (e.key) {
            case ' ': // [Spacebar]
            case 'k':
                storyReader.togglePlayPause();
                break;
            case 'ArrowLeft':
            case 'j':
                storyReader.prevClause();
                break;
            case 'ArrowRight':
            case 'l':
                storyReader.nextSection();
                break;

            case '`':
                playerLoadingScreen.style.visibility = (playerLoadingScreen.style.visibility == 'hidden') ? 'visible' : 'hidden';
                break;
        }
    });

    window.addEventListener('resize', e => {
        navTitle.innerHTML = (window.innerWidth < window.innerHeight) ? 'Eng-Chk Story Reader' : 'English-Chukchansi Story Reader';
    });
    navTitle.innerHTML = (window.innerWidth < window.innerHeight) ? 'Eng-Chk Story Reader' : 'English-Chukchansi Story Reader';

    // navButton.addEventListener('click', e => {
    //     navDropdown.style.visibility = (navDropdown.style.visibility=='hidden') ? 'visible' : 'hidden';
    // });
    // window.addEventListener('scroll', e => {
    //     // navDropdown.blur();
    //     // navButton.blur();
    //     document.body.focus();
    //     navTitle.style.color = '#ff0000';
    // },{ passive: true }); // passive:true guarantees no preventDefault(), so mobile won't check for it and can smooth scroll right away

    //////////////////////

    let stories = [
        story_sox_siksikaʔ,
        story_kaʔyuʔun_shashaʔ,
        story_ʔuplalliʔ_deemaysuʔ,
        story_shelel_shilithanaʔ
    ];
    
    loadStory(0);

</script>

</body>
</html>